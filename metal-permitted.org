Attempt to put together all that I have previously done on metal recombination lines, particularly in Orion

* New stuff [2017-10-24 Tue]

** Theoretical line strengths
*** TODO Get O II line strengths vs (n, T) from Storey (2017)
+ They have a fortran program to extract lines from their data base
+ Everything is here: [[file:Storey-2017/]] (but not on GitHub since too big)
*** TODO N II line strengths from Fang et al (2011)
+ Data is on Vizier:
  + http://vizier.cfa.harvard.edu/viz-bin/VizieR?-source=J/A+A/530/A18
+ There is a way to directly grab the data files into astropy tables
  + Example from [[id:37783AC4-74A2-48EC-AE19-006509FEA4F5][Stellar bow shock project]]
    #+BEGIN_SRC python
      SOURCE_DIR = 'OB/Kobulnicky2016'
      source_table = Table.read(
          os.path.join(SOURCE_DIR, 'table1.dat'),
          format='ascii.cds',
          readme=os.path.join(SOURCE_DIR, 'ReadMe')
      )
    #+END_SRC
*** TODO O I recombination line strengths from Pequignot et al (1991)
+ Simple functional fit to effective recombination rates
+ Equation
  \[
  \alpha = 10^{{-13}} \, z\,  \frac{a t^{b}}{1 + c t^{d}}
  \]
+ with \(z\) as ion charge (1 for O I) and \(t = 10^{-4} \, T/z^{2}\)
+ Co-efficients for O I 3s .^{5}S^0 - 3s .^{5}P
  | Ion | line | Case |     a |      b |     c |     d |  Br | Q |     Y |
  |-----+------+------+-------+--------+-------+-------+-----+---+-------|
  | O I | 7773 | A    | 1.983 | -0.630 | 0.971 | 0.573 | 1.0 | B | 1.006 |
  
** TODO Look at O I 7773 recombination line
+ From Jorge GarcÃ­a's talk
+ O I triplet at 7771 + 73 + 74 \AA
+ Supposedly a recombination line
+ I think we have it in the MUSE data
+ This is in wavelength section 5
+ [ ] It is also in Adal's slits
*** DONE First impressions
CLOSED: [2017-10-24 Tue 17:56]
+ Line clearly detected
+ Contaminated by night sky, which needs to be dealt with
+ To first order, looks like [O II] 7330
  + /Except/ it is missing some features:
    1. Narrow bright bar completely missing
    2. Orion S high-Te region is much weaker (not a surprise)
    3. HH 202 is weaker I think
*** TODO [2/5] Steps to reduce MUSE 7773 line
+ [X] Extract line
+ [X] Extract line better (turns out there is another line at 7780, which means that we can't get a continuum level on the red side of the line)
+ [ ] Deal with night sky component
  + Needs to be done panel by panel
  + Maybe use [O I] 5577 - *no, it is too different*
  + Work from outside \to inside and look for jumps between tiles
+ [ ] Multi-binning
+ [ ] Fuzzing
  + (or is that really necessary?)
  + might be, if we want to take ratios
** TODO Looking at all the MUSE O II and N II lines
+ These are in better shape than I thought
+ We should be able to get the O II V1 multiplet in three parts:
  1) 4642+39
     - cleanly extracted
     - but blended with N III and N II
  2) 4649+51
     - very badly extracted 
     - we will need to fit gaussians I think
     - to get densities, we need to discriminate 49 from 51
  3) 4674+76
     - a bit weak, but extracted OK
     - except that it is affected by the He II 4686 absorption
     - so best to use gaussians
+ Ratio 4642/5007 shows peak along rim of Big Arc
+ N II lines
  + 4607 is badly contaminated with [Fe III]
  + 4631 is OK but noisy
  + 4803 is weak and only to W of Trap
  + 5667, 5680 are similar (*multiplet 3*)
    + (combination of several components)
    + Additional weaker ones at 5686, 5711
    + Look similar to 4642, except for inner bits
    + 5680 could maybe used to remove N II from 4642
      + Recomb coeffs are in Pequignot et al 1991
      + Around 1.4e-13 (Case B) for 5680
      + But /doesn't give/ 4642
      + Fang 2011 has them too
      + Looks like *5680/5667 is a density indicator*
        + R = 2 => 1e4 pcc
        + R = 1.5 => 1e3 pcc
        + [X] Ratio needs maps to be binned
        + I get a gradient from about 1.7 to 1.4 from center to outskirt of the nebula.  But I have to bin it an awful lot
  + 5942 is clearly different and may have fluorescent component
*** Doing the multibinning in situ
Can do this on laptop
#+BEGIN_SRC sh :eval no :tangle selected-multibin.sh
  D=../multibin-maps
  for line in Ni_IV-5820 N_II-5680 N_II-5667 N_II-5942 O_II-4642 O_II-4676 O_I-7773 C_II-6462 C_II-6780; do
      python $D/multibin-map.py LineMaps/linesum-$line.fits
  done
#+END_SRC
Run in terminal

#+BEGIN_SRC sh
  python ../OrionMuse/muse_line_ratio.py N_II-5680 N_II-5667 linesum bin256
#+END_SRC

#+RESULTS:
: LineMaps/linesum-N_II-5680-bin256.fits LineMaps/linesum-N_II-5667-bin256.fits

#+BEGIN_SRC sh
  python ../OrionMuse/muse_line_ratio.py O_II-4642 O_III-5007 linesum bin032
#+END_SRC

#+RESULTS:
: LineMaps/linesum-O_II-4642-bin032.fits LineMaps/linesum-O_III-5007-bin032.fits

#+BEGIN_SRC sh
  python ../OrionMuse/muse_line_ratio.py O_I-7773 O_II-7330 linesum bin032
#+END_SRC

#+RESULTS:
: LineMaps/linesum-O_I-7773-bin032.fits LineMaps/linesum-O_II-7330-bin032.fits
*** Fuzzing and constant SNR will need to be done on the server
+ This needs the original data cubes, so I can't do it easily on laptop
+ Easiest approach may be to generate a new version of the line list
**** Selected line list
:PROPERTIES:
:TABLE_EXPORT_FILE: basic-line-list.tab
:TABLE_EXPORT_FORMAT: orgtbl-to-tsv
:ID:       B0593798-2E01-499E-965C-1E4A78025834
:END:

+ This is the lines from the [[id:30F9E738-EE31-4C62-B5CA-CE103485A481][big list]] that we are using in this project
+ Write to file with ~C-c t e~
| Ion    | Class |     wav0 | strength | blue cont | red cont | comment                      |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| O II   | P     |  4641.81 |        4 |         1 |        0 | blend N III + N II           |
| O II   | P     |  4650.00 |        4 |         1 |        0 | blend 4649.13,50.84          |
| O II   | P     |  4676.24 |        5 |         1 |        1 | blend with 4673.73           |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| O II   | P     |  5433.49 |        6 |         1 |        1 |                              |
| O II   | P     |  6501.40 |        7 |         1 |        0 | *** and 6500.83, 6501.42     |
| O II   | P     |  6509.80 |        7 |         0 |        1 | *** and 6509.711, 6510.61    |
| O II   | P     |   7340.7 |        5 |         0 |        1 | Or N II 7338.6               |
| O II   | P     | 7369.029 |        6 |         1 |        0 | blend C II 7370.0            |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| [O II] | M     |  7318.39 |        1 |         1 |        1 | Also 7319.99                 |
| [O II] | M     |  7329.66 |        1 |         0 |        1 | Also 7330.73                 |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| O I    | L     |  7773.37 |        5 |         1 |        0 | *** Mean 71.94,74.17,75.39   |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| N II   | P     |  4607.16 |        4 |         1 |        1 | blend [Fe III], O II 4609.44 |
| N II   | P     |  4630.54 |        4 |         1 |        0 |                              |
| N II   | P     | 4803.287 |        4 |         1 |        1 | blend [Co II] 4802.36        |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| N II   | P     | 5666.629 |        5 |         1 |        1 | multiplet 3  (contam low?)   |
| N II   | P     |  5676.02 |        6 |         0 |        0 | *** multiplet 3  - no good c |
| N II   | P     | 5679.558 |        5 |         1 |        1 | multiplet 3                  |
| N II   | P     |  5686.21 |        6 |         0 |        1 | *** multiplet 3              |
| N II   | P     |  5711.06 |        6 |         1 |        1 | *** multiplet 3              |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| N II   | P     |  5927.82 |        5 |         1 |        0 | ***                          |
| N II   | P     |  5931.78 |        4 |         0 |        1 | Blend with 5927.81           |
| N II   | P     |  5941.65 |        4 |         0 |        1 | Blend with 5940.24           |
| N II   | P     |  5952.39 |        4 |         1 |        0 | All multiplet 28             |
|--------+-------+----------+----------+-----------+----------+------------------------------|
| C II   | P     |  6151.43 |        5 |         1 |        0 | V16.04, pure recomb          |
| C II   | P     |  6461.95 |        6 |         1 |        1 | V17.04 Pure recomb           |

+ Ship to server
#+BEGIN_SRC sh :results verbatim
  date
  rsync -avzPL --info=progress0 basic-line-list.tab nil:/fs/nil/other0/will/orion-muse
#+END_SRC

#+RESULTS:
: Wed Oct 25 23:39:11 CDT 2017
: sending incremental file list
: basic-line-list.tab
: 
: sent 247 bytes  received 46 bytes  195.33 bytes/sec
: total size is 1,028  speedup is 3.51

+ Note that this overwrites the big file on the server, so if we want to do all the lines again, we have to [[id:E29DD76D-0B11-4F52-8B50-8967046D2F0C][re-sync]] from the ~OrionMuse~ project

**** DONE Fuzzing the selected lines on server
CLOSED: [2017-10-25 Wed 23:29]
+ Run this on ~nil~
  #+BEGIN_SRC sh :eval no
  python extract-em-line-fuzz.py
  #+END_SRC
+ [2017-10-25 Wed 17:55] Started running (after fixing bugs)
  + It is taking a minute or two per emission line, so it will be a while
+ [2017-10-25 Wed 18:35] finished now, in fact a while ago (so it is just over one minute per line, when doing 10 fuzzes)


***** DONE Updating ~extract-em-line-fuzz.py~
CLOSED: [2017-10-25 Wed 17:58]
+ It seems that I made some changes in Dec/Jan 2016/17 to the ways the lines are extracted
  + This changed the API for some of the utility functions
  + I removed all the heliocentric part
  + And replaced it with something simpler
  + This seems to have been motivated by the line widths project, but I don't remember exactly why
+ Anyhow, upshot is that ~extract-em-line-fuzz.py~ need updating to use new API
  + I can use as a guide the diffs for ~OrionMuse~ commit ~6b95fea~, where I did equivalent changes to ~extract-em-line.py~


**** DONE Multibinning all the fuzzed files
CLOSED: [2017-10-25 Wed 23:47]
+ Just doing the following to start with 
  #+BEGIN_EXAMPLE
  O_I-7773 O_II-4642 O_II-4676 N_II-5667 N_II-5680 C_II-6151 C_II-6462
  #+END_EXAMPLE
+ Used 
  #+BEGIN_SRC sh
  time python $D/multibin-map.py LineMaps/linesum-O_I-7773.fits
  #+END_SRC
  and similar to do the base map
+ And 
  #+BEGIN_SRC sh
  time sh one-line-fuzz-multibin.sh C_II-6151
  #+END_SRC
  for the fuzzed versions

**** DONE Calculate noise and s/n ratio
CLOSED: [2017-10-26 Thu 09:29]
+ Calculate s/n (example)
  #+BEGIN_SRC sh
  time python multibin-signal-to-noise.py linesum-N_II-5680
  #+END_SRC
+ Generate masks (example for s/n=5)
  #+BEGIN_SRC sh
  python multibin-mask-s-n.py linesum-O_I-7773 5
  #+END_SRC
+ Combine images (example)
  #+BEGIN_SRC 
  python multibin-combine-s-n.py linesum-O_I-7773 5  
  #+END_SRC
+ Copy them to laptop (example)
  #+BEGIN_SRC sh
  rsync -avzPL nil:/fs/nil/other0/will/orion-muse/LineMaps/linesum-O_I-7773-multibin-SN*.fits LineMaps  
  #+END_SRC
+ This is really calling out to be better automated


**** TODO Do the same for ratios

** Maybe even do the Si II lines?
** Copying some stuff from linux server
#+BEGIN_SRC sh :results verbatim
  date
  rsync -avzPL --info=progress0 nil:/fs/nil/other0/will/orion-muse/LineMaps/linesum-{O_II-4642,O_II-4650,O_II-4676,O_I-7773,O_II-5433,O_II-6501,O_II-6510,O_II-7318,O_II-7330,O_II-7341,O_II-7369,N_II-4607,N_II-4631,N_II-4803,N_II-5667,N_II-5680,N_II-5942,C_II-6462}.fits LineMaps
  rsync -avzPL --info=progress0 nil:/fs/nil/other0/will/orion-muse/LineMaps/linesum-{O_III-5007,O_II-7330,C_II-7231,C_II-7236}-bin{004,008,016,032}.fits LineMaps
  rsync -avzPL --info=progress0 nil:/fs/nil/other0/will/orion-muse/muse-hr-image-wfc3-f547m.fits .
#+END_SRC

#+RESULTS:
#+begin_example
Wed Oct 25 19:59:43 CDT 2017
receiving incremental file list

sent 11 bytes  received 410 bytes  168.40 bytes/sec
total size is 187,764,480  speedup is 445,996.39
receiving incremental file list
linesum-C_II-7231-bin004.fits
linesum-C_II-7231-bin008.fits
linesum-C_II-7231-bin016.fits
linesum-C_II-7231-bin032.fits
linesum-C_II-7236-bin004.fits
linesum-C_II-7236-bin008.fits
linesum-C_II-7236-bin016.fits
linesum-C_II-7236-bin032.fits
linesum-O_II-7330-bin004.fits
linesum-O_II-7330-bin008.fits
linesum-O_III-5007-bin004.fits
linesum-O_III-5007-bin008.fits
linesum-O_III-5007-bin016.fits

sent 258 bytes  received 7,091,003 bytes  429,773.39 bytes/sec
total size is 704,793,600  speedup is 99.39
receiving incremental file list

sent 11 bytes  received 82 bytes  37.20 bytes/sec
total size is 10,558,080  speedup is 113,527.74
#+end_example

* Possible explanations for ADF, etc
+ Note that ADF, t-squared and T_{4363/5007} - T_{V1/5007} are all the same thing observationally 
+ Recombination rate inaccuracies
  + Gary is very keen on this
  + Says that nobody understands DR properly
  + Something about the levels below (or was it above?) threshold that are not being accounted for (not sure exactly what he said)
  + Says that "someone or other" agrees with him (presumably a famous atomic physicist, but I don't remember the name)
  + Seems to me that this can only explain a wholesale shift in the ADF values, and not spatial variations in them
+ Fluorescence contribution
  + Vladimir has some calculations I think
  + This is certainly seen in the C II V3 multiplet: 7231, 36 lines
    + Should compare with the 6462 line, which is the best-looking of all the pure-recombination C II lines in MUSE
      + We can subtract a scaled 6462 from the 7231 and 7236 so we just leave the fluorescent contribution
      + Then we can do the same but subtracting scaled 5007 from 4651
        + Although the latter needs to be corrected for temperature since it is a CEL
    + Although Manu and Adal has 4267, which is much better
+ Metallicity variations
  + There will be slight enhancements in O when grains are destroyed
    + For instance, Adal's work on HH 202
    + Also, newer stuff by JosÃ© EspÃ­ritu, Gloria Delgado, Antonio P
    + Also, earlier Adal 2008 paper had something similar for HH 203/204
    + This should give correlation with Fe enhancement
      + So need to find a line ratio that is diagnostic of Fe abundance
      + This is difficult because most ratios are more sensitive to ionization
      + In the Manu work I had tried [Fe III] / ([S II] + [S III]) which worked OK
+ Underlying stellar absorption lines
  + Scattered light gives about half the continuum in Orion, so any stellar absorption lines will show up in the nebula, and might reduce the apparent strength of weak emission lines
  + This is particularly a problem for the O II lines, since they are quite strong in absorption in the O star spectra
    + Especially the O9/B0 stars: \theta^2 A, \theta^1 A and D, where O II 4651 is similar absorption depth to He II 4686, or about 0.1
    + In \theta^1 C, it is not so bad: depth of about 0.06 in He II 4686 (but depends on orbital phase!) and 0.03 in the O II lines
      + Note that Adal's spectra show *zero* He II 4686 absorption, weirdly
    + In the nebula, this is down to 0.04 for He II (presumably because of dilution)
    + Which implies 0.02 for O II, which is around 5-10% of the O II emission lines

* Guide to all my previous work
+ Figures that I am gathering from other places are in [[file:copied-figs/]] 
** General musings
+ I have a lot of discussion in the org file [[file:~/Work/RubinWFC3/Tsquared/recomb-lines.org][file:~/Work/RubinWFC3/Tsquared/recomb-lines.org]]
  + For example [[id:DE843C1D-0502-4DB0-8C49-538DAC045AF6][Fluorescence vs recombination for the permitted lines]]
    + where I draw on some of Vladimir's papers, but don't come to any firm conclusions
    + Although I note that the 4591 line gives an ADF of zero
+ 
** Ratios that should stay the same in the V1 multiplet
+ Theoretical ratios
  + 4642 / (4639+49+51+62) = 0.32
  + 4674 / (4639+49+51+62) = 0.13
  + 4676 / (4639+49+51+62) = 0.02
+ Manu spectra [[file:copied-figs/oii-insensitive-blue.pdf]]
  + Discussed in [[file:~/Work/RubinWFC3/Tsquared/Manu%20Spectra.ipynb][file:~/Work/RubinWFC3/Tsquared/Manu Spectra.ipynb]]
  + Need to add 43% N II + N III contamination to the 4642 line 
+ Adal spectra [[file:copied-figs/oii-insensitive-adal-slit6.pdf]]
  + Discussed in [[file:~/Work/RubinWFC3/Tsquared/Adal%20spectra.ipynb][file:~/Work/RubinWFC3/Tsquared/Adal spectra.ipynb]]
  + No need for correction for N II but N III is still blended - could maybe be resolved by fitting gaussians
** Density-sensitive ratios
+ He I 5876/6678 ratio
  + Trouble is, the MUSE maps show that this is largely due to extinction
  + Varies from 2.8 (high extinction) to 3.6 (low extinction)
  + Adal has it other way up: 0.3 to 0.34, so a similar range
+ Manu has [Cl III] and [Ar IV] ratios, which may be more sensible
  + [[file:copied-figs/oii-density-compare.pdf]]
  + [[file:copied-figs/oii-density-vs-radius.pdf]]
  + [[file:copied-figs/oii-vs-cliii-densities.pdf]]
    + Strangely, O II densities are lower than 
** Temperature-sensitive ratios
+ Adal spectra with binning has lots of plots, such as
  + [[file:copied-figs/oii-t-orlcel-vs-cel-adal-bin.png]]
  + [[file:copied-figs/oii-t-orl-vs-cel-adal-bin.png]]
+ Manu spectra
  + [[file:copied-figs/oii-oiii-temperature-masked.pdf]]
  + [[file:copied-figs/oii-oiii-temperature.pdf]]
  + [[file:copied-figs/oii-temperature-three-vs-radius.pdf]]
+ The comparison of T(ORL-CEL) with T(CEL) is consistent with a 10% difference between the two
+ The T(ORL) values from O II V1 4649 / V 15 4591 are strange
  + The ratio *falls* with radius for Manu data, which indicates that
    T is climbing!
    + Observed values \approx 10 at 30 arcsec, falling to 5 at 100 arcsec
    + Implying T rises from 3000 K to 7000 K
  + But Adal results are a /bit/ more sensible
    + There is a jump in the CEL T at the edge of Orion-S, with Orion S having a higher 4363/4959
    + It also has a lower V1/4959, consistent with higher T
    + And a lower 4649/4591 (about 6 => T = 5000 K)
    + Whereas directly below Trap has 4649/4591 = 9 => T = 4000 K
    + Equivalent T(CEL) are 8700 and 8400 K
+ *But note that these all need de-reddening*
+ Other T-sensitive ORL ratios are
  + 4649/4189
    + Looks like we can see it clearly in Manu spectra - not sure why I haven't measured it
  + 4649/4089
    + Affected by various blends
